
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>validation_fixer &#8212; NCCS Core Files 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for validation_fixer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">floor</span><span class="p">,</span> <span class="n">ceil</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">validate_ez</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">validate_full</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">validate_pf</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">data</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;Class&gt;</span>
<span class="sd">    &lt;Methods&gt;   &lt;description&gt;</span>
<span class="sd">        &lt;related methods&gt;</span>

<span class="sd">Utilities</span>
<span class="sd">    generate_token          builds a &quot;token&quot; dictionary to pass between the loops with all values necessary for the current EIN</span>
<span class="sd">    update_df_row           extracts an updated row from a token to write back to the dataframe</span>
<span class="sd">    get_components          handles cross-referencing equation components (denoted by the * in the display)</span>
<span class="sd">    load_data               loads the dataframe at the start of the program</span>
<span class="sd">    load_saved              loads previously saved entries and merges them</span>
<span class="sd">    sort_data               sorts data by the specified criteria on program start</span>
<span class="sd">    build_url               builds Foundation Center URLs from the current EINs data</span>
<span class="sd">    pdf_opener              opens Foundation Center PDFs in default browser</span>
<span class="sd">    get_form_crosswalk      connects column names to IRS form 990 lines for user reference</span>
<span class="sd">    process_token_storage   handles the restoring of the EIN placed on hold in order to go back one</span>

<span class="sd">Display</span>
<span class="sd">    display                     main display loop</span>
<span class="sd">    display_static_header       program info at top between the *** lines</span>
<span class="sd">    display_form_header         header with info on the current form, including eins completed/remaining - also has the validation reason from the current EIN</span>
<span class="sd">    display_ein_header          header with info on the current row, rev/ass/exp both current and prior, plus tax period</span>
<span class="sd">    display_failed_equations    manages the failed equation display between the --- lines</span>
<span class="sd">    failure_entries             used for updating the failed equations section on the fly</span>

<span class="sd">UserInput</span>
<span class="sd">    get_explanation     asks user to explain what was done</span>
<span class="sd">    get_user            initial setup questions</span>
<span class="sd">    col_viewer          helper function for formatting output</span>
<span class="sd">    user_input          main menu, and methods related to it:</span>
<span class="sd">        ui_fixed</span>
<span class="sd">        ui_checked</span>
<span class="sd">        ui_ignore</span>
<span class="sd">        ui_skip</span>
<span class="sd">        ui_reset</span>
<span class="sd">        ui_quit</span>
<span class="sd">        ui_options</span>
<span class="sd">        ui_done_so_far</span>
<span class="sd">        ui_view</span>
<span class="sd">        ui_view_group</span>
<span class="sd">        ui_modify_row</span>
<span class="sd">        ui_get_fix</span>

<span class="sd">CoreFixer</span>
<span class="sd">    __init__        environmental variables</span>
<span class="sd">    start           base method called to begin the validation tool</span>
<span class="sd">    dataframe_loop  manages the loop through every row of the dataframe</span>
<span class="sd">    row_loop        manages the loop through a single row until fixed</span>
<span class="sd">    end             handles wrap-up and saving</span>

<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="wprint"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.wprint">[docs]</a><span class="k">def</span> <span class="nf">wprint</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">chars</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ident</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="c1">#adds auto wrapping and optional indenting to printed text</span>
    <span class="n">first_line</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_line</span><span class="p">:</span>
            <span class="n">eol</span> <span class="o">=</span> <span class="n">chars</span> <span class="o">-</span> <span class="n">ident</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eol</span> <span class="o">=</span> <span class="n">chars</span>

        <span class="n">curr_line_rev</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">eol</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">curr_line_rev</span> <span class="ow">and</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">curr_line_rev</span><span class="p">:</span>
            <span class="n">split_pt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_line_rev</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">),</span> <span class="n">curr_line_rev</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">curr_line_rev</span><span class="p">:</span>
            <span class="n">split_pt</span> <span class="o">=</span> <span class="n">curr_line_rev</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">curr_line_rev</span><span class="p">:</span>
            <span class="n">split_pt</span> <span class="o">=</span> <span class="n">curr_line_rev</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">split_pt</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">eol</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">eol</span><span class="o">-</span><span class="n">split_pt</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">text</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first_line</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="n">ident</span> <span class="o">+</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_line</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></div>

<div class="viewcode-block" id="Utilities"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities">[docs]</a><span class="k">class</span> <span class="nc">Utilities</span><span class="p">():</span>
<div class="viewcode-block" id="Utilities.generate_token"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.generate_token">[docs]</a>    <span class="k">def</span> <span class="nf">generate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ein</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;EZ&#39;</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;EZ&#39;</span>
        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;990&#39;</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;Full&#39;</span>
        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;PF&#39;</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;PF&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;current_ein&#39;</span><span class="p">:</span>  <span class="n">ein</span><span class="p">,</span>
                 <span class="s1">&#39;irs_source&#39;</span> <span class="p">:</span>  <span class="n">source</span><span class="p">,</span>
                 <span class="s1">&#39;original_row&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">,</span>
                 <span class="s1">&#39;modified_row&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                 <span class="s1">&#39;exit&#39;</span><span class="p">:</span>  <span class="kc">False</span><span class="p">,</span>
                 <span class="s1">&#39;write&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="s1">&#39;changes&#39;</span><span class="p">:{}}</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="Utilities.update_df_row"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.update_df_row">[docs]</a>    <span class="k">def</span> <span class="nf">update_df_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">token</span><span class="p">[</span><span class="s1">&#39;current_ein&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span> <span class="c1">#write result back to original</span></div>

<div class="viewcode-block" id="Utilities.get_components"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.get_components">[docs]</a>    <span class="k">def</span> <span class="nf">get_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the methods for validation calculations from Core, then builds the cross references</span>
<span class="sd">        needed to track relations between equations (e.g. one equation that fails has TOTREV2 in it,</span>
<span class="sd">        so the program finds all equations with TOTREV2 and displays those also)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#creates an instance of the validation code from the main program</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EZ&#39;</span><span class="p">:</span><span class="n">ValidateEZ</span><span class="p">(),</span>
                     <span class="s1">&#39;Full&#39;</span><span class="p">:</span><span class="n">ValidateFull</span><span class="p">(),</span>
                     <span class="s1">&#39;PF&#39;</span><span class="p">:</span><span class="n">ValidatePF</span><span class="p">()}</span>

        <span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">validators</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">equations</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">validators</span><span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;validate_ez_totrev&#39;</span><span class="p">:</span> <span class="n">validator</span><span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ez_validate_totrev</span><span class="p">,</span>
                      <span class="s1">&#39;validate_ez_netinc&#39;</span><span class="p">:</span> <span class="n">validator</span><span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ez_validate_netinc</span><span class="p">,</span>
                      <span class="s1">&#39;validate_ez_ass_eoy&#39;</span><span class="p">:</span> <span class="n">validator</span><span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ez_validate_ass_eoy</span><span class="p">,</span>
                      <span class="s1">&#39;validate_ez_saleothn&#39;</span><span class="p">:</span> <span class="n">validator</span><span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ez_validate_saleothn</span><span class="p">,</span>
                      <span class="s1">&#39;validate_ez_netincfndrsng&#39;</span><span class="p">:</span> <span class="n">validator</span><span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ez_validate_netincfndrsng</span><span class="p">,</span>
                      <span class="s1">&#39;validate_ez_grprof&#39;</span><span class="p">:</span> <span class="n">validator</span><span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ez_validate_grprof</span>
                      <span class="p">}</span>

        <span class="n">validators</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;validate_fu_netrent&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">full_validate_netrent</span><span class="p">,</span>
                      <span class="s1">&#39;validate_fu_netgnls&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">full_validate_netgnls</span><span class="p">,</span>
                      <span class="s1">&#39;validate_fu_netincfndrsng&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">full_validate_netincfndrsng</span><span class="p">,</span>
                      <span class="s1">&#39;validate_fu_netincgaming&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">full_validate_netincgaming</span><span class="p">,</span>
                      <span class="s1">&#39;validate_fu_grprof&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">full_validate_grprof</span><span class="p">,</span>
                      <span class="s1">&#39;validate_fu_totrev2&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">full_validate_totrev2</span><span class="p">,</span>
                      <span class="s1">&#39;validate_fu_fundbal&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">full_validate_fundbal</span>
                      <span class="p">}</span>

        <span class="n">validators</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;validate_pf_p1totrev&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p1totrev</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p1totexp&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p1totexp</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p1excrev&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p1excrev</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p2tinvsc&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p2tinvsc</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14tnadj&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14tnadj</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14tqdis&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14tqdis</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14tasvl&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14tasvl</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14t4942&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14t4942</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14tendw&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14tendw</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14ttsup&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14ttsup</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14tpsup&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14tpsup</span><span class="p">,</span>
                            <span class="s1">&#39;validate_pf_p14tginv&#39;</span><span class="p">:</span><span class="n">validator</span><span class="p">[</span><span class="s1">&#39;PF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pf_validate_p14tginv</span>
                            <span class="p">}</span>

        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">,</span> <span class="s1">&#39;Full&#39;</span><span class="p">,</span> <span class="s1">&#39;PF&#39;</span><span class="p">]:</span>
            <span class="n">equations</span><span class="p">[</span><span class="n">form</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="n">v</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixer_display</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validators</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">components</span><span class="p">[</span><span class="n">form</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">({</span><span class="n">kk</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="s1">&#39;+-=()&#39;</span><span class="p">}))</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">equations</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">all_cols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">multiples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cross_components_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">,</span> <span class="s1">&#39;Full&#39;</span><span class="p">,</span> <span class="s1">&#39;PF&#39;</span><span class="p">]:</span>
            <span class="n">all_cols</span><span class="p">[</span><span class="n">form</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">components</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span> <span class="c1">#all_cols[form] = [&#39;col1&#39;, &#39;col2&#39;, &#39;col3&#39;...]</span>

            <span class="n">multiples</span><span class="p">[</span><span class="n">form</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">uniques</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_cols</span><span class="p">[</span><span class="n">form</span><span class="p">]))</span> <span class="c1">#unique list of every column in components keys or values</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">uniques</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">all_cols</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">multiples</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1">#reverse the components dict, so every name that shows up more than once is a key, while the key it shows up in in components is a value</span>
            <span class="n">cross_components_dict</span><span class="p">[</span><span class="n">form</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">multiples</span><span class="p">[</span><span class="n">form</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">components</span><span class="p">[</span><span class="n">form</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">cross_components_dict</span><span class="p">[</span><span class="n">form</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">cross_components_dict</span><span class="p">[</span><span class="n">form</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cross_components_dict</span><span class="p">[</span><span class="n">form</span><span class="p">])</span>

        <span class="c1">#pointers for ease of reference later</span>
        <span class="n">components</span><span class="p">[</span><span class="s1">&#39;FU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span>
        <span class="n">cross_components_dict</span><span class="p">[</span><span class="s1">&#39;FU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross_components_dict</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span>
        <span class="n">multiples</span><span class="p">[</span><span class="s1">&#39;FU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiples</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span>
        <span class="n">validators</span><span class="p">[</span><span class="s1">&#39;FU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">validators</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span>
        <span class="n">equations</span><span class="p">[</span><span class="s1">&#39;FU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">equations</span><span class="p">[</span><span class="s1">&#39;Full&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">components</span><span class="p">,</span> <span class="n">cross_components_dict</span><span class="p">,</span> <span class="n">multiples</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">validators</span></div>

<div class="viewcode-block" id="Utilities.load_data"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.load_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;failures&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_validate.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_strings</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;EIN&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">num_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num_cols</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_adjusted_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#initialize empty adjustment tracking columns</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;EXPLANATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load_df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_df</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1">#if the main process has been rerun and new validation output is present, but the fixes already applied haven&#39;t been deleted from the folder, they will fail to assign</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: It appears the existing fixes have already been integrated into the main process, as some of the EINs in the saved fix content are no longer marked for validating.&#39;</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Press any key to continue WITHOUT loading the fixes.  They will be OVERWRITTEN the next time you save.  Otherwise please exit the program to resolve the conflict.&#39;</span><span class="p">)</span>

        <span class="n">failures</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;validate_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;adjusted&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">failures</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">failures</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#filters out any entries that have already been solved (does not filter any entries if there is no loaded content)</span>
        <span class="c1">#stopped filtering this way to avoid overwriting content on save changes only, now just used to calculate start length.</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;INCLUDE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">failures</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_REASON&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_criteria</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]))))</span>
        <span class="c1"># df = df[df[&#39;INCLUDE&#39;]]</span>
        <span class="n">start_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;INCLUDE&#39;</span><span class="p">]])</span>
        <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;INCLUDE&#39;</span><span class="p">]</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_REASON&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_REASON&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_criteria</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_cols</span> <span class="o">=</span> <span class="n">num_cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failures</span> <span class="o">=</span> <span class="n">failures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_len</span> <span class="o">=</span> <span class="n">start_len</span></div>

<div class="viewcode-block" id="Utilities.load_saved"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.load_saved">[docs]</a>    <span class="k">def</span> <span class="nf">load_saved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="c1">#form: (str) co, pc, pf</span>
        <span class="n">load_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;fixes&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_validate.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">make_strings</span><span class="p">)</span>
        <span class="n">load_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;EIN&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">tracking_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;final output&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_change_tracker.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">())),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;EIN&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">})</span>
        <span class="n">tracking_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;EIN&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">load_df</span> <span class="o">=</span> <span class="n">load_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tracking_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">assert</span><span class="p">((</span><span class="n">load_df</span><span class="p">[</span><span class="s1">&#39;_merge&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;Warning, EINs do not line up when merging existing changes with change tracking.&#39;</span>
        <span class="n">load_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;_merge&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">load_df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_REASON&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">load_df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_REASON&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_criteria</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> previously completed rows loaded.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">load_df</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">load_df</span></div>

<div class="viewcode-block" id="Utilities.sort_data"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.sort_data">[docs]</a>    <span class="k">def</span> <span class="nf">sort_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span>
        <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;PF&#39;</span><span class="p">:</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="s1">&#39;P1TOTREV&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="s1">&#39;TOTREV2&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;VALIDATION_REASON&#39;</span><span class="p">,</span> <span class="n">rev</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span></div>

<div class="viewcode-block" id="Utilities.build_url"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.build_url">[docs]</a>    <span class="k">def</span> <span class="nf">build_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">taxperp</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;PF&#39;</span><span class="p">:</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="s1">&#39;pf&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">taxperp</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;http://990s.foundationcenter.org/990</span><span class="si">{}</span><span class="s1">_pdf_archive/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">filename</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn_split</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">pfn</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="n">fn_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">taxperp</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.0&#39;</span><span class="p">),</span> <span class="n">fn_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">])</span>
            <span class="k">return</span> <span class="s1">&#39;http://990s.foundationcenter.org/990</span><span class="si">{}</span><span class="s1">_pdf_archive/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pf</span><span class="p">,</span> <span class="n">filename</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pfn</span><span class="p">)</span></div>

<div class="viewcode-block" id="Utilities.pdf_opener"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.pdf_opener">[docs]</a>    <span class="k">def</span> <span class="nf">pdf_opener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">taxperp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">taxperp</span><span class="p">)</span>
        <span class="n">webbrowser</span><span class="o">.</span><span class="n">open_new_tab</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="Utilities.get_form_crosswalk"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.get_form_crosswalk">[docs]</a>    <span class="k">def</span> <span class="nf">get_form_crosswalk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For connecting column names to 990 form locations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;FULL&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;Part VIII Line 1h&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 2g (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 3A&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 4A&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 5A&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 6a (i)&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Part VIII Line 6a (ii)&#39;</span><span class="p">,</span> <span class="s1">&#39;Sum of Part VIII Line 6a (i) and (ii)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 6b (i)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 6b (ii)&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Sum of Part VIII Line 6b (i) and (ii)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 6c (i)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 6c (ii)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 6d (A)&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Part VIII Line 7a (i)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 7b (i)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 7c (i)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 7a (ii)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 7b (ii)&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Part VIII Line 7c (ii)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 7d&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 8a&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 8b&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 8c&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 9a&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Part VIII Line 9b&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 9c&#39;</span><span class="p">,</span> <span class="s1">&#39;Sum of Part VIII Line 8a and 9a&#39;</span><span class="p">,</span> <span class="s1">&#39;Sum of Part VIII Line 8b and 9b&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Sum of Part VIII Line 8c (A) and 9c (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 10a&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 10b&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 10c (A)&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Part VIII Line 11e (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part VIII Line 12 (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part IX Line 5 (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part IX Line 7 (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part IX Line 10 (A)&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Part IX Line 11e (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part IX Line 25 (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 16 (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 16 (B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 20 (B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 23 (B)&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;Part X Line 24 (B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 26 (A)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 26 (B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 32 (B)&#39;</span><span class="p">,</span> <span class="s1">&#39;Part X Line 33 (B)&#39;</span><span class="p">],</span>
                                           <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;CONT&#39;</span><span class="p">,</span> <span class="s1">&#39;PROGREV&#39;</span><span class="p">,</span> <span class="s1">&#39;INVINC&#39;</span><span class="p">,</span> <span class="s1">&#39;TXEXMPTBNDSPROCEEDS&#39;</span><span class="p">,</span> <span class="s1">&#39;ROYALTSINC&#39;</span><span class="p">,</span> <span class="s1">&#39;GRSRNTSREAL&#39;</span><span class="p">,</span> <span class="s1">&#39;GRSRNTSPRSNL&#39;</span><span class="p">,</span> <span class="s1">&#39;RENTINC&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLEXPNSREAL&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLEXPNSPRSNL&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;RENTEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLINCREAL&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLINCPRSNL&#39;</span><span class="p">,</span> <span class="s1">&#39;NETRENT&#39;</span><span class="p">,</span> <span class="s1">&#39;SECUR&#39;</span><span class="p">,</span> <span class="s1">&#39;SALESEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;SALESECN&#39;</span><span class="p">,</span> <span class="s1">&#39;SALEOTHG&#39;</span><span class="p">,</span> <span class="s1">&#39;SALEOTHE&#39;</span><span class="p">,</span> <span class="s1">&#39;SALEOTHN&#39;</span><span class="p">,</span> <span class="s1">&#39;NETGNLS&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;GRSINCFNDRSNG&#39;</span><span class="p">,</span> <span class="s1">&#39;LESSDIRFNDRSNG&#39;</span><span class="p">,</span> <span class="s1">&#39;NETINCFNDRSNG&#39;</span><span class="p">,</span> <span class="s1">&#39;GRSINCGAMING&#39;</span><span class="p">,</span> <span class="s1">&#39;LESSDIRGAMING&#39;</span><span class="p">,</span> <span class="s1">&#39;NETINCGAMING&#39;</span><span class="p">,</span> <span class="s1">&#39;SPEVTG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIREXP&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNDINC&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;INVENTG&#39;</span><span class="p">,</span> <span class="s1">&#39;GOODS&#39;</span><span class="p">,</span> <span class="s1">&#39;GRPROF&#39;</span><span class="p">,</span> <span class="s1">&#39;OTHINC&#39;</span><span class="p">,</span> <span class="s1">&#39;TOTREV2&#39;</span><span class="p">,</span> <span class="s1">&#39;COMPENS&#39;</span><span class="p">,</span> <span class="s1">&#39;OTHSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;PAYTAX&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNDFEES&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPS&#39;</span><span class="p">,</span> <span class="s1">&#39;ASS_BOY&#39;</span><span class="p">,</span> <span class="s1">&#39;ASS_EOY&#39;</span><span class="p">,</span> <span class="s1">&#39;BOND_EOY&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;MRTG_EOY&#39;</span><span class="p">,</span> <span class="s1">&#39;UNSECUREDNOTESEND&#39;</span><span class="p">,</span> <span class="s1">&#39;LIAB_BOY&#39;</span><span class="p">,</span> <span class="s1">&#39;LIAB_EOY&#39;</span><span class="p">,</span> <span class="s1">&#39;RETEARN&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNDBAL&#39;</span><span class="p">],</span>
                                           <span class="p">),</span>
                <span class="s1">&#39;EZ&#39;</span><span class="p">:</span>   <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;PF&#39;</span><span class="p">:</span>   <span class="kc">None</span><span class="p">}</span></div>

<div class="viewcode-block" id="Utilities.process_token_storage"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Utilities.process_token_storage">[docs]</a>    <span class="k">def</span> <span class="nf">process_token_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for when the user has gone back to the previous token and then finished it and needs to restore the delayed one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_df_row</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>         <span class="c1">#update the df with the prior token</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span><span class="p">[</span><span class="s1">&#39;on_hold&#39;</span><span class="p">]</span>   <span class="c1">#extract the token that was placed on hold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span><span class="p">[</span><span class="s1">&#39;on_hold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1">#empty the token storage</span>
        <span class="k">return</span> <span class="n">token</span>                            <span class="c1">#return the token that was placed on hold and make it the current token</span></div></div>

<div class="viewcode-block" id="Display"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Display">[docs]</a><span class="k">class</span> <span class="nc">Display</span><span class="p">():</span>
<div class="viewcode-block" id="Display.display"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Display.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_static_header</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_form_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_ein_header</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_failed_equations</span><span class="p">(</span><span class="n">token</span><span class="p">)</span></div>

<div class="viewcode-block" id="Display.display_static_header"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Display.display_static_header">[docs]</a>    <span class="k">def</span> <span class="nf">display_static_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cls&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span> <span class="k">else</span> <span class="s1">&#39;clear&#39;</span><span class="p">)</span>
        <span class="n">line0</span> <span class="o">=</span> <span class="s1">&#39;****************************************&#39;</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="s1">&#39;NCCS Core File Validation Tool v7.2017&#39;</span>
        <span class="n">line2</span> <span class="o">=</span> <span class="s1">&#39;Created by Jeff Levy (jlevy@urban.org)&#39;</span>
        <span class="n">line_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">line0</span><span class="p">,</span> <span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">,</span> <span class="n">line0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">line_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">))</span></div>

<div class="viewcode-block" id="Display.display_form_header"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Display.display_form_header">[docs]</a>    <span class="k">def</span> <span class="nf">display_form_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span>
        <span class="n">num_fixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_fixed</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_len</span> <span class="o">-</span> <span class="n">num_fixed</span>

        <span class="n">ein</span>       <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;current_ein&#39;</span><span class="p">]</span>
        <span class="n">firm_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">][</span><span class="s1">&#39;NAME&#39;</span><span class="p">])</span>
        <span class="n">reason</span>    <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">][</span><span class="s1">&#39;VALIDATION_REASON&#39;</span><span class="p">]</span>

        <span class="n">lcol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">rcol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">-</span> <span class="n">lcol</span><span class="p">)</span>

        <span class="n">sides</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">cent</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sides</span><span class="p">)</span>

        <span class="n">line4a</span> <span class="o">=</span> <span class="s1">&#39;Form: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span>
        <span class="n">line4c</span> <span class="o">=</span> <span class="s1">&#39;Validation Reasons: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">reason</span><span class="p">)))</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span>
        <span class="n">line4b</span> <span class="o">=</span> <span class="s1">&#39;EINs Completed: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_fixed</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span>
        <span class="n">line5a</span> <span class="o">=</span> <span class="s1">&#39;EIN:  </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ein</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">lcol</span><span class="p">)</span>
        <span class="n">line5b</span> <span class="o">=</span> <span class="s1">&#39;EINs Remaining: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">rcol</span><span class="p">)</span>
        <span class="n">line6</span>  <span class="o">=</span> <span class="n">firm_name</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">)</span>
        <span class="n">line7</span>  <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">firm_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;--&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line4a</span><span class="o">+</span><span class="n">line4c</span><span class="o">+</span><span class="n">line4b</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line5a</span><span class="o">+</span><span class="n">line5b</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line6</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line7</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">))</span></div>

<div class="viewcode-block" id="Display.display_ein_header"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Display.display_ein_header">[docs]</a>    <span class="k">def</span> <span class="nf">display_ein_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;irs_source&#39;</span><span class="p">]</span>

        <span class="n">sides</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">cent</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sides</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;EZ&#39;</span><span class="p">,</span> <span class="s1">&#39;Full&#39;</span><span class="p">]:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TOTREV2&#39;</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;EXPS&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ASS_EOY&#39;</span><span class="p">]))</span>
            <span class="n">prior</span>   <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TOTREVP&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;EXPSP&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ASS_BOY&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;PF&#39;</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;P1TOTREV&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;P1TOTEXP&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;P2TOTAST&#39;</span><span class="p">]))</span>
            <span class="n">prior</span>   <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current</span><span class="p">,</span> <span class="n">prior</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">taxper</span> <span class="o">=</span> <span class="s1">&#39;TAX PERIOD: &#39;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TAXPER&#39;</span><span class="p">][:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TAXPER&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">taxper</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current</span><span class="p">:</span>
            <span class="n">line1</span> <span class="o">=</span> <span class="s1">&#39;CURRENT: Revenue: </span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Expenses: </span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Assets: </span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prior</span><span class="p">:</span>
            <span class="n">line2</span> <span class="o">=</span> <span class="s1">&#39;PRIOR:   Revenue: </span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prior</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Expenses: </span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prior</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">cent</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Assets: </span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prior</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sides</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current</span> <span class="ow">or</span> <span class="n">prior</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">))</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Display.display_failed_equations"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Display.display_failed_equations">[docs]</a>    <span class="k">def</span> <span class="nf">display_failed_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_entries</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>

            <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">[</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">fail</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">fail</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">eq</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col</span><span class="o">+</span><span class="s1">&#39; [</span><span class="si">{:,.0f}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>

            <span class="n">entries</span> <span class="o">=</span> <span class="s1">&#39;$</span><span class="si">{:,.0f}</span><span class="s1"> = &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">fail</span><span class="p">]))</span> <span class="o">+</span> <span class="n">eq</span>
            <span class="k">for</span> <span class="n">multiple</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiples</span><span class="p">[</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]:</span>
                <span class="n">entries</span> <span class="o">=</span> <span class="n">entries</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">multiple</span><span class="p">,</span> <span class="n">multiple</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>

            <span class="n">ident</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">[</span><span class="mi">12</span><span class="p">:])</span><span class="o">+</span><span class="mi">6</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">fail</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ident</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">wprint</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">ident</span><span class="o">=</span><span class="n">ident</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No validation failures found.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">))</span></div>

<div class="viewcode-block" id="Display.failure_entries"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.Display.failure_entries">[docs]</a>    <span class="k">def</span> <span class="nf">failure_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>

        <span class="n">failures</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">failures</span><span class="p">]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">failures</span><span class="p">[(</span><span class="nb">abs</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)]</span> <span class="c1">#display all failure columns</span>

        <span class="c1">#adds to the display any columns that passed validation, but contain columns that are parts of columns that did fail validation</span>
        <span class="n">add_related</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span> <span class="c1">#e.g. fail=&#39;validate_ez_totrev&#39;</span>
            <span class="n">fail_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">fail</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="c1">#e.g. fail_components=[&#39;CONT&#39;, &#39;PRGMSRVREV&#39;...]</span>
            <span class="k">for</span> <span class="n">fail_component</span> <span class="ow">in</span> <span class="n">fail_components</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fail_component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiples</span><span class="p">[</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]:</span>
                    <span class="n">component_sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_components</span><span class="p">[</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">fail_component</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">potential</span> <span class="ow">in</span> <span class="n">component_sources</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;validate_&#39;</span><span class="o">+</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">potential</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">failures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">add_related</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;validate_&#39;</span><span class="o">+</span><span class="n">fail</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">potential</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_related</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">failures</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">failures</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">add_related</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">failures</span></div></div>

<div class="viewcode-block" id="UserInput"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput">[docs]</a><span class="k">class</span> <span class="nc">UserInput</span><span class="p">():</span>
<div class="viewcode-block" id="UserInput.get_explanation"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.get_explanation">[docs]</a>    <span class="k">def</span> <span class="nf">get_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Enter an explanation for what was done to this row:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    1) Error on form: fields do not sum to total&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    2) Error in data: fields not as represented on form&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    3) Unable to fix: 990 image missing&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    4) Unable to fix: fields missing&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    5) Form OK, no change&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Other (type very short explanation)&#39;</span><span class="p">)</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>

        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;EXPLANATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.get_user"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.get_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_static_header</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current threshold for a validation failure is: $</span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                  for a &quot;large&quot; firm: $</span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">large_firm</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                  for a firm with &quot;large changes&quot;: </span><span class="si">{:.1%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please enter your name: &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Which form will you be validating? [CO, PC, PF]: &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CO&#39;</span><span class="p">,</span> <span class="s1">&#39;PC&#39;</span><span class="p">]:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">form</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;PF&#39;</span><span class="p">:</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">yr</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;    for which NCCS release year? [YYYY]: &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">yr_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yr</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">yr_num</span>
                    <span class="k">break</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pdfs</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Do you wish to automatically open each 990 original in a browser tab? [y/n]: &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pdfs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_pdfs</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">pdfs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_pdfs</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_change_tracker.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;final output&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Existing output for this form appears to be available.  Do you wish to load it? [y/n]&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="n">load_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_saved</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: the program will overwrite this output when it finishes, if you leave it in the destination folders.  Press &quot;y&quot; to continue without loading, or any other key to cancel.&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Note: If you wish to keep the other files but not load them, you may move them from the &quot;fixed validations&quot; and &quot;final output&quot; folders now, then press &quot;y&quot; to resume.&#39;</span><span class="p">)</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">load_df</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Please handle the existing output and then run the validation fixer again.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">load_df</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No existing output found.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Beginning validation...&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_df</span> <span class="o">=</span> <span class="n">load_df</span></div>

<div class="viewcode-block" id="UserInput.col_viewer"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.col_viewer">[docs]</a>    <span class="k">def</span> <span class="nf">col_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">choice</span><span class="p">):</span>
        <span class="c1">#choice should be a list of column names, e.g. [&#39;TOTREV2&#39;, &#39;NETRENT&#39;]</span>
        <span class="k">def</span> <span class="nf">format_fn</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span> <span class="c1">#if a column is a string</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_crosswalk</span><span class="p">[</span><span class="s1">&#39;FULL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;990 LOCATION&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">choice</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">format_fn</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;VALUE&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No valid columns entered.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">values</span><span class="p">,</span> <span class="n">parts</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">parts</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;990 LOCATION&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;990 LOCATION&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;VALUE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()])</span></div>

<div class="viewcode-block" id="UserInput.user_input"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.user_input">[docs]</a>    <span class="k">def</span> <span class="nf">user_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="c1">#row = the original row from the dataframe</span>
        <span class="c1">#new_row = the row from the dataframe with whatever modifications have been applied</span>
        <span class="c1">#failures = a list of column names that begin with &#39;validate_&#39;</span>
        <span class="c1">#form = &#39;CO&#39;, etc</span>

        <span class="n">row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;original_row&#39;</span><span class="p">]</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nb">int</span><span class="p">((</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">))</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1">#print(&#39;\n* means the column shows up in other validation calculations.\n&#39;)</span>
        <span class="c1"># print(&#39;Enter a column name to change its value, (v)iew to see a column value, or:&#39;)</span>
        <span class="c1"># print(&#39;  (F)ixed, (C)hecked\n  (I)gnore, (S)kip\n  (R)eset, (Q)uit\n&#39;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ENTER A COLUMN NAME to change its value, or:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(v)  view any columns     | (f) to mark EIN as fixed       | (r) to revert this EINs values&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(vr) view revenue columns | (c) to mark EIN as checked     | (d) for what has been done so far&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(va) view asset columns   | (i) to ignore this EIN         | (q) to quit&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(ve) view expense columns | (s) to skip this EIN for later | (o) for options</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="c1">#catch descriptive user input and convert to key letters</span>
            <span class="n">key_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;view&#39;</span><span class="p">:</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;fixed&#39;</span><span class="p">:</span><span class="s1">&#39;f&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;checked&#39;</span><span class="p">:</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;ignore&#39;</span><span class="p">:</span><span class="s1">&#39;i&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;skip&#39;</span><span class="p">:</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;revert&#39;</span><span class="p">:</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;quit&#39;</span><span class="p">:</span><span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;options&#39;</span><span class="p">:</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;revenue&#39;</span><span class="p">:</span><span class="s1">&#39;vr&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;asset&#39;</span><span class="p">:</span><span class="s1">&#39;va&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;assets&#39;</span><span class="p">:</span><span class="s1">&#39;va&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;expense&#39;</span><span class="p">:</span><span class="s1">&#39;ve&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;expenses&#39;</span><span class="p">:</span><span class="s1">&#39;ve&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;done&#39;</span><span class="p">:</span><span class="s1">&#39;d&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">key_dict</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">key_dict</span><span class="p">[</span><span class="n">task</span><span class="p">]</span>

            <span class="n">menu</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;f&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_fixed</span><span class="p">,</span>
                    <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_checked</span><span class="p">,</span>
                    <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_ignore</span><span class="p">,</span>
                    <span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_skip</span><span class="p">,</span>
                    <span class="s1">&#39;r&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_reset</span><span class="p">,</span>
                    <span class="s1">&#39;q&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_quit</span><span class="p">,</span>
                    <span class="s1">&#39;o&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_options</span><span class="p">,</span>
                    <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_done_so_far</span><span class="p">,</span>
                    <span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_view</span><span class="p">,</span>
                    <span class="s1">&#39;vr&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_view_group</span><span class="p">,</span>
                    <span class="s1">&#39;va&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_view_group</span><span class="p">,</span>
                    <span class="s1">&#39;ve&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ui_view_group</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">menu</span><span class="p">[</span><span class="n">task</span><span class="p">](</span><span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">token</span>
            <span class="k">elif</span> <span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">new_row</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()],</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Only values in numerical columns may be changed using the fixer, please make a separate note of any other necessary changes.&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui_modify_row</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_fixed"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_fixed">[docs]</a>    <span class="k">def</span> <span class="nf">ui_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;original_row&#39;</span><span class="p">]</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span>

        <span class="n">no_changes_made</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>
        <span class="n">all_validations_fixed</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="n">failures</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">no_changes_made</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No changes made to this EIN, so it cannot be marked as fixed.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">all_validations_fixed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validation failures remain at the </span><span class="si">{}</span><span class="s1"> threshold.  Do you want to:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    (s)ave and let the errors be picked up by future validation&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    (i)gnore the remaining errors in future validation, but save the current fixes&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    (c)ontinue working on this EIN&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                    <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                    <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This EIN has been changed.&#39;</span><span class="p">)</span>
            <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">#for when it passes both conditionals (changes, and all errors fixed)</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_checked"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_checked">[docs]</a>    <span class="k">def</span> <span class="nf">ui_checked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;original_row&#39;</span><span class="p">]</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span>

        <span class="n">equal_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPLANATION&#39;</span><span class="p">,</span> <span class="s1">&#39;validated_by&#39;</span><span class="p">]))</span> <span class="c1">#these columns may not match do to prior token restoring, but that&#39;s okay</span>
        <span class="n">no_changes_made</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">equal_cols</span><span class="p">]</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="n">equal_cols</span><span class="p">])</span>

        <span class="n">all_validations_fixed</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="n">failures</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_changes_made</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Changes were made to this EIN, so it cannot be marked as checked.&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">all_validations_fixed</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This row has validation failures above the threshold, so it cannot be marked as checked.&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Marking this row as verified correct without changes.  This will prevent marking as a &quot;large&quot; or &quot;large change&quot;, but will not prevent being marked as a validation failure.  Press &quot;c&quot; again to confirm:&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span>
                    <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_ignore"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_ignore">[docs]</a>    <span class="k">def</span> <span class="nf">ui_ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Caution!  This will mark remaining errors or flags for this form to be ignored.  Press &quot;i&quot; again to proceed: &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Marking this EIN for ignoring in future validations.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_skip"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_skip">[docs]</a>    <span class="k">def</span> <span class="nf">ui_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="c1">#returns the original row and marks it as unresolved</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Undoing any changes and leaving this EIN to be picked up in future validations.  Press &quot;s&quot; again to confirm: &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;original_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_reset"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_reset">[docs]</a>    <span class="k">def</span> <span class="nf">ui_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="c1">#returns the original row, where it overwrites new_row and is passed back for another round</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All changes discarded, now displaying original values.&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;original_row&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_quit"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_quit">[docs]</a>    <span class="k">def</span> <span class="nf">ui_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;If you quit without saving then changes made to ALL EINS from this session will be DISCARDED.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Also note that you must complete the current EIN and then quit, if you wish to save any work on it.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;(r)esume, (s)ave first, or (q)uit without saving? [r/s/q]: &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">changes_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Output saved.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;No changes saved; bye!&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
                <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_options"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_options">[docs]</a>    <span class="k">def</span> <span class="nf">ui_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Options Menu:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;1. Open the PDF of the most recent 990 | 5. View the five most recently completed EINs&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;2. Open the PDF of the previous 990    | 6. See any previous explanations for this EIN &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;3. Open the 990 PDF search page        | 7. Go back to the previous EIN and place the current&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;4. Toggle default PDF opening          |    on hold (changes will not be lost)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                                       |&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;8. Save without exiting                | 9. Cancel</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pdf_opener</span><span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">])</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;TAXPERP&#39;</span> <span class="ow">in</span> <span class="n">new_row</span><span class="o">.</span><span class="n">index</span> <span class="ow">and</span> <span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;TAXPERP&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pdf_opener</span><span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">],</span> <span class="n">taxperp</span><span class="o">=</span><span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;TAXPERP&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Prior tax return date not in file; please go to http://foundationcenter.org/find-funding/990-finder or select option 3.&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pdf_opener</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s1">&#39;http://foundationcenter.org/find-funding/990-finder&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open_pdfs</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_pdfs</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Most recent on the left:&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prior_five</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">_</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Press any key to continue.&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Last explanation entered for this EIN: &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">new_row</span><span class="p">[</span><span class="s1">&#39;EXPLANATION&#39;</span><span class="p">])</span>
                <span class="n">_</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Press any key to continue.&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span><span class="p">[</span><span class="s1">&#39;prior&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The current EIN will automatically resume where you left off when you complete the restored one.  Restoring...&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span><span class="p">[</span><span class="s1">&#39;on_hold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span><span class="p">[</span><span class="s1">&#39;prior&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No previous EIN saved.  Are you on the first one of this session?&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;8&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">save_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">changes_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s1">&#39;9&#39;</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_done_so_far"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_done_so_far">[docs]</a>    <span class="k">def</span> <span class="nf">ui_done_so_far</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No changes to this EIN yet.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Press enter to continue.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_view"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_view">[docs]</a>    <span class="k">def</span> <span class="nf">ui_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter any number of column names (upper or lower case) separated by spaces: &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Note that invalid entries will show up as nan.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">col_viewer</span><span class="p">(</span><span class="n">new_row</span><span class="p">,</span> <span class="n">choice</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Press any key to continue.&#39;</span><span class="p">)</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
            <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_view_group"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_view_group">[docs]</a>    <span class="k">def</span> <span class="nf">ui_view_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;VR&#39;</span><span class="p">:[</span><span class="s1">&#39;CONT&#39;</span><span class="p">,</span> <span class="s1">&#39;PROGREV&#39;</span><span class="p">,</span> <span class="s1">&#39;INVINC&#39;</span><span class="p">,</span> <span class="s1">&#39;TXEXMPTBNDSPROCEEDS&#39;</span><span class="p">,</span> <span class="s1">&#39;ROYALTSINC&#39;</span><span class="p">,</span> <span class="s1">&#39;GRSRNTSREAL&#39;</span><span class="p">,</span> <span class="s1">&#39;GRSRNTSPRSNL&#39;</span><span class="p">,</span> <span class="s1">&#39;RENTINC&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLEXPNSREAL&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLEXPNSPRSNL&#39;</span><span class="p">,</span> <span class="s1">&#39;RENTEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLINCREAL&#39;</span><span class="p">,</span> <span class="s1">&#39;RNTLINCPRSNL&#39;</span><span class="p">,</span> <span class="s1">&#39;NETRENT&#39;</span><span class="p">,</span> <span class="s1">&#39;SECUR&#39;</span><span class="p">,</span> <span class="s1">&#39;SALESEXP&#39;</span><span class="p">,</span> <span class="s1">&#39;SALESECN&#39;</span><span class="p">,</span> <span class="s1">&#39;SALEOTHG&#39;</span><span class="p">,</span> <span class="s1">&#39;SALEOTHE&#39;</span><span class="p">,</span> <span class="s1">&#39;SALEOTHN&#39;</span><span class="p">,</span> <span class="s1">&#39;NETGNLS&#39;</span><span class="p">,</span> <span class="s1">&#39;GRSINCFNDRSNG&#39;</span><span class="p">,</span> <span class="s1">&#39;LESSDIRFNDRSNG&#39;</span><span class="p">,</span> <span class="s1">&#39;NETINCFNDRSNG&#39;</span><span class="p">,</span> <span class="s1">&#39;GRSINCGAMING&#39;</span><span class="p">,</span> <span class="s1">&#39;LESSDIRGAMING&#39;</span><span class="p">,</span> <span class="s1">&#39;NETINCGAMING&#39;</span><span class="p">,</span> <span class="s1">&#39;SPEVTG&#39;</span><span class="p">,</span> <span class="s1">&#39;DIREXP&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNDINC&#39;</span><span class="p">,</span> <span class="s1">&#39;INVENTG&#39;</span><span class="p">,</span> <span class="s1">&#39;GOODS&#39;</span><span class="p">,</span> <span class="s1">&#39;GRPROF&#39;</span><span class="p">,</span> <span class="s1">&#39;OTHINC&#39;</span><span class="p">,</span> <span class="s1">&#39;TOTREV2&#39;</span><span class="p">],</span>
                <span class="s1">&#39;VE&#39;</span><span class="p">:[</span><span class="s1">&#39;COMPENS&#39;</span><span class="p">,</span> <span class="s1">&#39;OTHSAL&#39;</span><span class="p">,</span> <span class="s1">&#39;PAYTAX&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNDFEES&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPS&#39;</span><span class="p">],</span>
                <span class="s1">&#39;VA&#39;</span><span class="p">:[</span><span class="s1">&#39;ASS_BOY&#39;</span><span class="p">,</span> <span class="s1">&#39;ASS_EOY&#39;</span><span class="p">,</span> <span class="s1">&#39;BOND_EOY&#39;</span><span class="p">,</span> <span class="s1">&#39;MRTG_EOY&#39;</span><span class="p">,</span> <span class="s1">&#39;UNSECUREDNOTESEND&#39;</span><span class="p">,</span> <span class="s1">&#39;LIAB_BOY&#39;</span><span class="p">,</span> <span class="s1">&#39;LIAB_EOY&#39;</span><span class="p">,</span> <span class="s1">&#39;RETEARN&#39;</span><span class="p">,</span> <span class="s1">&#39;FUNDBAL&#39;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col_viewer</span><span class="p">(</span><span class="n">new_row</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
        <span class="n">_</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Press any key to continue.&#39;</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_modify_row"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_modify_row">[docs]</a>    <span class="k">def</span> <span class="nf">ui_modify_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;original_row&#39;</span><span class="p">]</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;modified_row&#39;</span><span class="p">]</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failures</span>

        <span class="c1">#update entry</span>
        <span class="k">if</span> <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MANUALLY_FIXED&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MANUALLY_FIXED&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">:</span>
            <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MANUALLY_FIXED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MANUALLY_FIXED&#39;</span><span class="p">]:</span>
                <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MANUALLY_FIXED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;MANUALLY_FIXED&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1">#sets the new value in the row copy? from the dataframe</span>
        <span class="n">fix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ui_get_fix</span><span class="p">(</span><span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()],</span> <span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
        <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">fix</span> <span class="c1">#adjusts the actual column that starts at the initial value</span>
        <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_adjusted_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;_adjusted_by&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">fix</span> <span class="c1">#adjust the tracking column that starts at 0</span>
        <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>

        <span class="c1">#update change tracking in the token</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">]:</span>
            <span class="n">token</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">][</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">fix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">][</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">+=</span> <span class="n">fix</span>

        <span class="c1">#now that the entry is updated, we go back to the validation code and recalculate the error</span>

        <span class="c1">#first find out if this column in this row was calculated using EZ, Full or PF code</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;990&#39;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;FU&#39;</span>
        <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pf&#39;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;PF&#39;</span>
        <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ez&#39;</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;EZ&#39;</span>

        <span class="k">for</span> <span class="n">val_col</span><span class="p">,</span> <span class="n">val_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_method_dict</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">val_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_func</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>

        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">done</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="UserInput.ui_get_fix"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.UserInput.ui_get_fix">[docs]</a>    <span class="k">def</span> <span class="nf">ui_get_fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prev_val</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">current_val</span><span class="p">):</span>
        <span class="c1"># prev_val - entry value from column</span>
        <span class="c1"># col      - column name in upper case</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">change</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Change </span><span class="si">{}</span><span class="s1"> by (or type &quot;L&quot; to enter a new level): &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">change</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;Level&#39;</span><span class="p">,</span> <span class="s1">&#39;LEVEL&#39;</span><span class="p">]:</span>
                <span class="n">new_level</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Enter a new level for </span><span class="si">{}</span><span class="s1">: &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">change</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_level</span><span class="p">)</span> <span class="o">-</span> <span class="n">current_val</span>
                    <span class="k">break</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">change</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">change</span></div></div>

<div class="viewcode-block" id="CoreFixer"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.CoreFixer">[docs]</a><span class="k">class</span> <span class="nc">CoreFixer</span><span class="p">(</span><span class="n">Utilities</span><span class="p">,</span> <span class="n">Display</span><span class="p">,</span> <span class="n">UserInput</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_fixed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_len</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_pdfs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_five</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">=</span> <span class="mi">99</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pause</span> <span class="o">=</span> <span class="o">.</span><span class="mi">75</span>

        <span class="c1">#holding place for the ability to load the last token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;on_hold&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

        <span class="c1">#these must match the settings used when the core files being validated were created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">large_firm</span> <span class="o">=</span> <span class="mi">10000000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="o">.</span><span class="mi">50</span>

        <span class="c1">#column dtypes are inferred automatically unless specified as strings here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_strings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;EIN&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;TAXPER&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;TAXPERP&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;FISYR&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;FISYRP&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;MANUALLY_FIXED&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">:</span><span class="s1">&#39;str&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_crosswalk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_form_crosswalk</span><span class="p">()</span>

        <span class="c1">#the order in which data is sorted in the validation_reason column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_criteria</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CFL&#39;</span><span class="p">,</span> <span class="s1">&#39;CLF&#39;</span><span class="p">,</span> <span class="s1">&#39;LFC&#39;</span><span class="p">,</span> <span class="s1">&#39;LCF&#39;</span><span class="p">,</span> <span class="s1">&#39;FCL&#39;</span><span class="p">,</span> <span class="s1">&#39;FLC&#39;</span><span class="p">,</span> <span class="s1">&#39;FL&#39;</span><span class="p">,</span> <span class="s1">&#39;LF&#39;</span><span class="p">,</span> <span class="s1">&#39;CF&#39;</span><span class="p">,</span> <span class="s1">&#39;FC&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;CL&#39;</span><span class="p">,</span> <span class="s1">&#39;LC&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">]</span>

        <span class="c1">#these are carried as instance objects rather than local objects for debugging and exploration after the code is run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_components</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_method_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_components</span><span class="p">()</span>

<div class="viewcode-block" id="CoreFixer.start"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.CoreFixer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main process called on the class instance to begin the validator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoreFixer.dataframe_loop"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.CoreFixer.dataframe_loop">[docs]</a>    <span class="k">def</span> <span class="nf">dataframe_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates through each row in the dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ein</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1">#only process a row that isn&#39;t marked &quot;ignore&quot; and that has a failure or is not marked fixed/checked</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">failures</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">])):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_pdfs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_opener</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">])</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(</span><span class="n">ein</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="c1">#new token for the current row</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_loop</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="c1">#main loop for row processing</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">update_df_row</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_fixed</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span><span class="p">[</span><span class="s1">&#39;prior&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prior_five</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="p">[</span><span class="s1">&#39;current_ein&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_five</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span></div>

<div class="viewcode-block" id="CoreFixer.row_loop"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.CoreFixer.row_loop">[docs]</a>    <span class="k">def</span> <span class="nf">row_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Continues to loop the same row through the display until it receives an exit condition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_input</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_storage</span><span class="p">[</span><span class="s1">&#39;on_hold&#39;</span><span class="p">]:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_token_storage</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_explanation</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">token</span></div>

<div class="viewcode-block" id="CoreFixer.end"><a class="viewcode-back" href="../validation_fixer.html#validation_fixer.CoreFixer.end">[docs]</a>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changes_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">save_only</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">wprint</span><span class="p">(</span><span class="s1">&#39;Done with document, updated data written to the &quot;fixed validations&quot; folder.  Run the core file process again and it will incorporate your changes, then re-validate.&#39;</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Change tracking outputted to &quot;final output&quot; folder.&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span>

        <span class="k">if</span> <span class="n">changes_only</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;VALIDATION_STATE&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;EXPLANATION&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>

        <span class="n">val_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_adjusted_by&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_cols</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;validated_by&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPLANATION&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">val_cols</span><span class="p">)]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">,</span> <span class="s1">&#39;fixes&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_validate.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span>
        <span class="n">df</span><span class="p">[</span><span class="n">val_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;final output&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_change_tracker.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">lower</span><span class="p">())))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Changes saved.&#39;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause</span><span class="p">)</span></div></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">fixer</span> <span class="o">=</span> <span class="n">CoreFixer</span><span class="p">()</span>
    <span class="n">fixer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">NCCS Core Files</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Setup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../main.html">Main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build_nccs.html">Build</a></li>
</ul>
<p class="caption"><span class="caption-text">Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../load_data.html">Load Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Process</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process.html">Process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process_full.html">Process Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process_ez.html">Process EZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process_pf.html">Process PF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../process_co_pc.html">Process CO PC</a></li>
</ul>
<p class="caption"><span class="caption-text">Validate</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../validate.html">Validate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validate_full.html">Validate Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validate_ez.html">Validate EZ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validate_pf.html">Validate PF</a></li>
</ul>
<p class="caption"><span class="caption-text">Write</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../write.html">Write</a></li>
</ul>
<p class="caption"><span class="caption-text">Validation Fixer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../validation_fixer.html">Validation Fixer CLI Tool</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Urban Institute, National Center for Charitable Statistics.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>